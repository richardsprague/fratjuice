---
title: "Phyloseqify the Fratjuice samples"
author: "Richard Sprague"
date: "1/5/2018"
output: github_document
---

Load the prerequisites:

```{r}
library(phyloseq)
library(actino)
library(tidyverse)
SAMPLEDIR <- "../samples/ubiome/ubiome-processed-outputs"

```

Read the mapping data into a more familiar "Actino-style" mapfile

```{r}
results <- readxl::read_excel(file.path(SAMPLEDIR,"/results.xlsx"))
ssrs <- results$SeqID
username <- results$Sample_ID
mapping_df <- data.frame(SSR=ssrs,id=username)
```

Save it as an Excel file to be later readable by the actino functions.
You only have to run this chunk once. It's commented now because I already created the map file.

```{r}
#library(xlsx)
#xlsx::write.xlsx(mapping, file = paste0(SAMPLEDIR,"/json/frat_map_file.xlsx"), row.names = FALSE)
```

Now create the Phyloseq object
```{r, message= FALSE}
sample_files<-actino::just_json_files_in(file.path(SAMPLEDIR,"/json"))

frat_map_file <- paste0(SAMPLEDIR,"/json/frat_map_file.xlsx")
fratjuice.phylum <- actino::phyloseq_from_JSON_at_rank(sampleFiles,frat_map_file,rank = "phylum", count.normalized = TRUE)
fratjuice.genus <- actino::phyloseq_from_JSON_at_rank(sampleFiles,frat_map_file,rank = "genus", count.normalized = TRUE)
sample_data(fratjuice.genus)$id <- mapping_df$id
fratjuice.species <- actino::phyloseq_from_JSON_at_rank(sampleFiles,frat_map_file,rank = "species", count.normalized = TRUE)
sample_data(fratjuice.genus)$id <- mapping_df$id

```

plot the Phylum level

```{r}
sample_data(fratjuice.phylum)$id <- mapping_df$id
plot_bar(fratjuice.phylum, fill = "Phylum", x = "id") + 
  scale_y_continuous(labels=function(x)x/10000) + ylab("Abundance (%)")
```

There are `r nrow(otu_table(fratjuice.genus))` unique genus-level taxa found in these samples, so showing all of them would take up too much space.  Let's just plot the most common ones:

```{r}
frat.topgenus <- prune_taxa(taxa_sums(fratjuice.genus)>50000,fratjuice.genus)
plot_bar(frat.topgenus, fill = "Genus", x = "id") + 
  scale_y_continuous(labels=function(x)x/10000) + ylab("Abundance (%)")
```


